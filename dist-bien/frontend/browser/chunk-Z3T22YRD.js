import{a as W,b as H,c as J}from"./chunk-TTMTEO5N.js";import{Aa as N,Ba as O,Ja as R,Ka as B,Ma as q,Na as G,U as S,Y as $,b as V,d as A,g as U,o as z,ya as j,za as F}from"./chunk-3RZ5VAT3.js";import{C as L,Ca as p,Db as T,Ha as d,Ib as w,Ma as M,Sa as x,Za as m,da as f,ea as y,f as Q,fb as r,gb as n,hb as C,lb as _,nb as g,ob as u,wb as c,xb as P,yb as D}from"./chunk-NAVADJE2.js";var s=Q(W());var X=(a,t,e,i)=>({"bg-blue-500":a,"bg-orange-500":t,"bg-green-500":e,"bg-red-500":i});function Y(a,t){a&1&&(r(0,"tr")(1,"th"),c(2,"ID"),n(),r(3,"th"),c(4,"Direcci\xF3n"),n(),r(5,"th"),c(6,"Estado"),n(),r(7,"th"),c(8,"Acciones"),n()())}function Z(a,t){if(a&1){let e=_();r(0,"p-button",16),g("onClick",function(){f(e);let o=u().$implicit,l=u();return y(l.updatePackageStatus(o.id,"en_transito"))}),n()}}function ee(a,t){if(a&1){let e=_();r(0,"p-button",17),g("onClick",function(){f(e);let o=u().$implicit,l=u();return y(l.updatePackageStatus(o.id,"entregado"))}),n()}}function te(a,t){if(a&1){let e=_();r(0,"p-button",18),g("onClick",function(){f(e);let o=u().$implicit,l=u();return y(l.updatePackageStatus(o.id,"regresado"))}),n()}}function ie(a,t){if(a&1&&(r(0,"tr")(1,"td"),c(2),n(),r(3,"td"),c(4),n(),r(5,"td")(6,"span",12),c(7),n()(),r(8,"td"),x(9,Z,1,0,"p-button",13)(10,ee,1,0,"p-button",14)(11,te,1,0,"p-button",15),n()()),a&2){let e=t.$implicit;p(2),P(e.id),p(2),P(e.delivery_address),p(2),m("ngClass",w(7,X,e.status==="asignado",e.status==="en_transito",e.status==="entregado",e.status==="regresado")),p(),D(" ",e.status," "),p(2),m("ngIf",e.status==="asignado"),p(),m("ngIf",e.status==="en_transito"),p(),m("ngIf",e.status==="en_transito")}}var K=class a{constructor(t,e,i,o,l,E){this.authService=t;this.deliveryService=e;this.packageService=i;this.socketService=o;this.router=l;this.messageService=E}packages=[];map;marker=null;currentPosition=null;subscriptions=[];defaultPosition={latitude:19.4326,longitude:-99.1332};routeLines={};destinationMarkers={};simulationInProgress=!1;ngOnInit(){this.tryGetInitialPosition(),this.loadPackages(),this.authService.currentUserValue&&this.authService.isDelivery&&this.socketService.notifyDeliveryLogin(this.authService.currentUserValue),this.subscriptions.push(this.socketService.onRouteSimulationUpdated().subscribe(t=>{let e=this.authService.currentUserValue?.id;t.deliveryId===e&&this.handleRouteSimulation(t)}))}ngOnDestroy(){this.subscriptions.forEach(t=>t.unsubscribe()),this.map&&this.map.remove()}tryGetInitialPosition(){navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{let{latitude:e,longitude:i}=t.coords;this.currentPosition={latitude:e,longitude:i},this.initMap(e,i),this.startLocationTracking()},t=>{console.error("Error getting initial location",t),this.initMap(this.defaultPosition.latitude,this.defaultPosition.longitude),this.startLocationTracking(),this.messageService.add({severity:"warn",summary:"Advertencia",detail:"No se pudo obtener tu ubicaci\xF3n inicial. Usando ubicaci\xF3n por defecto."})},{timeout:5e3,enableHighAccuracy:!0}):(this.initMap(this.defaultPosition.latitude,this.defaultPosition.longitude),this.startLocationTracking(),this.messageService.add({severity:"error",summary:"Error",detail:"Geolocalizaci\xF3n no soportada en este navegador"}))}initMap(t,e){this.map&&this.map.remove(),this.map=s.map("map").setView([t,e],15),s.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"\xA9 OpenStreetMap contributors"}).addTo(this.map),this.updateMapPosition(t,e)}loadPackages(){this.packageService.getPackagesByDelivery().subscribe({next:t=>{this.packages=t},error:t=>{this.messageService.add({severity:"error",summary:"Error",detail:"No se pudieron cargar los paquetes"})}})}startLocationTracking(){this.subscriptions.push(L(1e4).subscribe(()=>{this.getCurrentPosition()}))}getCurrentPosition(){navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{let{latitude:e,longitude:i}=t.coords;console.log("Coordenadas obtenidas:",{latitude:e,longitude:i}),this.currentPosition={latitude:e,longitude:i},this.updateMapPosition(e,i),this.sendLocationUpdate(e,i)},t=>{console.error("Error getting location",t),this.messageService.add({severity:"error",summary:"Error",detail:"No se pudo obtener la ubicaci\xF3n"})},{enableHighAccuracy:!0}):this.messageService.add({severity:"error",summary:"Error",detail:"Geolocalizaci\xF3n no soportada en este navegador"})}updateMapPosition(t,e){if(this.map.setView([t,e],15),this.marker)this.marker.setLatLng([t,e]);else{let i=s.divIcon({className:"delivery-icon",html:'<div style="font-size: 30px; text-shadow: 0px 0px 3px white, 0px 0px 5px white;">\u{1F3CD}\uFE0F</div>',iconSize:[30,30],iconAnchor:[15,15]});this.marker=s.marker([t,e],{icon:i}).addTo(this.map),this.marker.bindPopup("Mi ubicaci\xF3n actual").openPopup()}}sendLocationUpdate(t,e){let i=this.authService.currentUserValue?.id;i&&(this.deliveryService.updateLocation(t,e).subscribe(),this.socketService.updateLocation({userId:i,latitude:t,longitude:e}))}updatePackageStatus(t,e){this.packageService.updatePackageStatus(t,e).subscribe({next:i=>{let o=this.packages.findIndex(l=>l.id===t);o!==-1&&(this.packages[o].status=i.status),this.socketService.updatePackageStatus({packageId:t,status:e}),this.messageService.add({severity:"success",summary:"\xC9xito",detail:"Estado del paquete actualizado"})},error:i=>{this.messageService.add({severity:"error",summary:"Error",detail:i.error?.message||"No se pudo actualizar el estado"})}})}logout(){this.authService.logout(),this.router.navigate(["/login"])}handleRouteSimulation(t){let{route:e,destination:i,address:o,currentStep:l,totalSteps:E,status:k,packageId:I}=t;if(k==="start"){this.clearSimulation(),this.simulationInProgress=!0;let v=s.polyline(e.map(h=>[h.lat,h.lng]),{color:"#ff6b35",weight:3,opacity:.8,dashArray:"8, 12"}).addTo(this.map);this.routeLines[1]=v;let b=s.divIcon({html:`
          <div style="
            background-color: #FF4444;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
          ">
            \u{1F4CD}
          </div>
        `,iconSize:[30,30],iconAnchor:[15,30]});this.destinationMarkers[1]=s.marker([i.lat,i.lng],{icon:b}).bindPopup(`<b>Destino:</b><br>${o}`).addTo(this.map),this.map.fitBounds(v.getBounds(),{padding:[50,50]}),this.messageService.add({severity:"info",summary:"\u{1F680} Simulaci\xF3n Iniciada",detail:`En camino a ${o}`,life:3e3})}else if(k==="update"&&this.simulationInProgress){let v=e[l];if(this.marker){let b=this.marker.getElement();b&&(b.style.transition="all 0.3s ease-out"),this.marker.setLatLng([v.lat,v.lng]);let h=Math.round(l/E*100);this.marker.bindPopup(`
          <div style="text-align: center;">
            <b>\u{1F69A} En ruta</b><br>
            <small>Destino: ${o}</small><br>
            <div style="background: #e0e0e0; border-radius: 10px; padding: 2px; margin: 5px 0;">
              <div style="background: #4caf50; height: 8px; border-radius: 8px; width: ${h}%;"></div>
            </div>
            <small>${h}% completado</small>
          </div>
        `)}}else k==="complete"&&(this.clearSimulation(),I&&this.updatePackageStatus(I,"entregado"),this.messageService.add({severity:"success",summary:"\u2705 Entrega Completada",detail:`Paquete entregado en ${o}`,life:5e3}),this.loadPackages())}clearSimulation(){this.simulationInProgress=!1,this.routeLines[1]&&(this.map.removeLayer(this.routeLines[1]),delete this.routeLines[1]),this.destinationMarkers[1]&&(this.map.removeLayer(this.destinationMarkers[1]),delete this.destinationMarkers[1])}static \u0275fac=function(e){return new(e||a)(d(G),d(H),d(J),d(q),d(z),d(S))};static \u0275cmp=M({type:a,selectors:[["app-delivery"]],features:[T([S])],decls:21,vars:1,consts:[[1,"grid"],[1,"col-12"],[1,"flex","justify-content-between","align-items-center","mb-3"],["icon","pi pi-sign-out","label","Cerrar Sesi\xF3n",3,"onClick"],[1,"card",2,"height","400px"],["id","map",2,"height","300px"],[1,"mt-2"],["icon","pi pi-map-marker","label","Actualizar Ubicaci\xF3n",3,"onClick"],[1,"card"],["styleClass","p-datatable-sm",3,"value"],["pTemplate","header"],["pTemplate","body"],[1,"text-white","px-2","py-1","border-round",3,"ngClass"],["label","En Tr\xE1nsito","styleClass","p-button-warning p-button-sm mr-2",3,"onClick",4,"ngIf"],["label","Entregado","styleClass","p-button-success p-button-sm mr-2",3,"onClick",4,"ngIf"],["label","Regresado","styleClass","p-button-danger p-button-sm",3,"onClick",4,"ngIf"],["label","En Tr\xE1nsito","styleClass","p-button-warning p-button-sm mr-2",3,"onClick"],["label","Entregado","styleClass","p-button-success p-button-sm mr-2",3,"onClick"],["label","Regresado","styleClass","p-button-danger p-button-sm",3,"onClick"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1"),c(4,"Panel de Delivery"),n(),r(5,"p-button",3),g("onClick",function(){return i.logout()}),n()()(),r(6,"div",1)(7,"div",4)(8,"h2"),c(9,"Mi Ubicaci\xF3n"),n(),C(10,"div",5),r(11,"div",6)(12,"p-button",7),g("onClick",function(){return i.getCurrentPosition()}),n()()()(),r(13,"div",1)(14,"div",8)(15,"h2"),c(16,"Mis Paquetes"),n(),r(17,"p-table",9),x(18,Y,9,0,"ng-template",10)(19,ie,12,12,"ng-template",11),n()()()(),C(20,"p-toast")),e&2&&(p(17),m("value",i.packages))},dependencies:[U,V,A,F,j,$,B,R,O,N],styles:["[_nghost-%COMP%]{display:block;padding:1rem}.delivery-icon[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;z-index:1000}"]})};export{K as DeliveryComponent};
